# مختبر أمان JWT - JWT Authentication Security Lab

هذا المشروع يوضح الفرق بين تطبيق JWT آمن وآخر ضعيف، ويظهر الثغرات الأمنية الشائعة في JWT وكيفية حمايتها.

## 🚀 البدء السريع

### المتطلبات الأساسية
- Node.js (الإصدار 14 أو أحدث)
- npm
- Wireshark (لتحليل حركة المرور)

### التثبيت والإعداد

1. **تثبيت المكتبات المطلوبة:**
   ```bash
   npm install
   ```

2. **إعداد متغيرات البيئة:**
   ```bash
   # انسخ ملف البيئة
   cp .env.example .env
   
   # قم بتوليد أسرار آمنة
   node -e "console.log('ACCESS_SECRET=' + require('crypto').randomBytes(64).toString('hex')); console.log('REFRESH_SECRET=' + require('crypto').randomBytes(64).toString('hex'));"
   ```

3. **تهيئة قاعدة البيانات:**
   ```bash
   npm run init-db
   ```

4. **تشغيل الخوادم:**
   ```bash
   # تشغيل الخادم الضعيف (المنفذ 1234)
   npm run start-vuln
   
   # تشغيل الخادم الآمن (المنفذ 1235) 
   npm run start-secure
   
   # أو تشغيل الخادم الآمن افتراضياً
   npm start
   ```

5. **الوصول للتطبيق:**
   - الخادم الضعيف: http://localhost:1234
   - الخادم الآمن: http://localhost:1235

## 🔐 إعداد متغيرات البيئة

### مطلوب: إعداد ملف .env

**مهم جداً:** انسخ ملف `.env.example` إلى `.env` وقم بتعيين جميع الأسرار:

```bash
# انسخ القالب
cp .env.example .env

# قم بتوليد أسرار آمنة
node -e "console.log('ACCESS_SECRET=' + require('crypto').randomBytes(64).toString('hex')); console.log('REFRESH_SECRET=' + require('crypto').randomBytes(64).toString('hex'));"
```

### توليد الأسرار

استخدم وحدة crypto في Node.js لتوليد أسرار آمنة:

```javascript
// توليد أسرار عشوائية آمنة (64 بايت = 128 حرف hex)
const crypto = require('crypto');
const accessSecret = crypto.randomBytes(64).toString('hex');
const refreshSecret = crypto.randomBytes(64).toString('hex');
```

## 🛡️ الميزات الأمنية

### الخادم الآمن (المنفذ 1235)

#### ✅ التدابير الأمنية المطبقة

1. **التكوين القائم على البيئة**
   - جميع الأسرار محفوظة في ملف `.env`
   - لا توجد بيانات اعتماد مبرمجة في الكود المصدري
   - التحقق من البيئة عند بدء التشغيل

2. **مطالبات الرمز القوية والتحقق**
   - **المصدر (`iss`)**: `jwt-lab-secure`
   - **الجمهور (`aud`)**: `jwt-lab-client`
   - **الخوارزمية**: `HS256` فقط بشكل صارم
   - **الانتهاء**: 15 دقيقة لرموز الوصول
   - **التحقق**: جميع المطالبات يتم التحقق منها في كل طلب

3. **استراتيجية رمز التحديث**
   - **دوران الرمز**: رموز التحديث القديمة تُبطل عند الاستخدام
   - **أسرار منفصلة**: أسرار مختلفة عن رموز الوصول
   - **ملفات تعريف الارتباط HttpOnly**: رموز التحديث غير قابلة للوصول عبر JavaScript
   - **التخزين على الخادم**: معرفات رموز التحديث متتبعة في الذاكرة
   - **البحث عن الدور من قاعدة البيانات**: أدوار المستخدمين يتم جلبها من قاعدة البيانات لرموز الوصول الجديدة

### الخادم الضعيف (المنفذ 1234)

#### ⚠️ الميزات الضعيفة عمداً

1. **سر ضعيف**: `weak-secret-lab-only` (سهل التخمين)
2. **انتهاء صلاحية طويل**: 7 أيام لرموز الوصول
3. **هجوم خوارزمية None**: يقبل رموز `{"alg":"none"}`
4. **عدم التحقق من المطالبات**: مفقود التحقق من المصدر/الجمهور
5. **تخزين localStorage**: الرموز قابلة للوصول عبر JavaScript

## 🎯 عرض الهجمات

### الهجوم الأول: هجوم خوارزمية None

**الهدف**: الخادم الضعيف (المنفذ 1234)

1. **الحصول على رمز صالح** بتسجيل الدخول بشكل طبيعي
2. **فك تشفير الرمز** باستخدام زر "Whoami"
3. **تعديل الرأس** إلى `{"alg":"none"}`
4. **إزالة التوقيع** (الجزء الثالث من JWT)
5. **إرسال الرمز المعدل** إلى نقطة النهاية `/admin`

**النتيجة المتوقعة**: الوصول مُمنح بالرمز المعدل

**الحماية**: الخادم الآمن يرفض رموز `alg: none`

### الهجوم الثاني: تزوير الرمز بالسر الضعيف

**الهدف**: الخادم الضعيف (المنفذ 1234)

1. **استخدام السر الضعيف المعروف**: `weak-secret-lab-only`
2. **إنشاء رمز مزور** بدور المدير
3. **إرسال الرمز المزور** إلى نقطة النهاية `/admin`

**النتيجة المتوقعة**: الوصول مُمنح بالرمز المزور

**الحماية**: الخادم الآمن يستخدم أسرار قوية تشفيرياً

## 🧪 أوامر الاختبار

### اختبار الهجمات

```bash
# توليد رموز الهجوم
node attack-demos.js

# عرض الملخص الكامل للأمان
node security-demo.js
```

### اختبار API يدوياً

```bash
# تسجيل الدخول للخادم الآمن
curl -X POST http://localhost:1235/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"adminpass"}' \
  -c cookies.txt

# الوصول لنقطة النهاية الإدارية
curl http://localhost:1235/admin \
  -H "Authorization: Bearer <ACCESS_TOKEN>" \
  -b cookies.txt
```

## 📁 هيكل المشروع

```
jwt/
├── .env.example           # قالب متغيرات البيئة
├── .gitignore            # ملفات مستبعدة من Git
├── package.json          # المكتبات والأوامر
├── init-db.js           # تهيئة قاعدة البيانات
├── secure-server.js     # خادم JWT محمي
├── vuln-server.js       # خادم JWT ضعيف  
├── attack-demos.js      # سكريبت عرض الهجمات
├── security-demo.js     # ملخص الأمان الكامل
├── README.md            # التوثيق بالإنجليزية
├── README_AR.md         # التوثيق بالعربية
└── public/              # ملفات الواجهة الأمامية
    ├── index.html       # التطبيق الرئيسي
    ├── script.js        # JavaScript من جانب العميل
    └── style.css        # التنسيق
```

## 🔧 الأوامر المتاحة

- `npm run init-db`: تهيئة قاعدة البيانات مع مستخدمين عينة
- `npm run start-vuln`: تشغيل الخادم الضعيف (المنفذ 1234)
- `npm run start-secure`: تشغيل الخادم الآمن (المنفذ 1235)  
- `npm start`: تشغيل الخادم الآمن (افتراضي)

## 👥 المستخدمين العينة

| اسم المستخدم | كلمة المرور | الدور |
|----------|----------|------|
| admin | adminpass | admin |
| alice | alicepass | user |

## ⚠️ ملاحظات أمنية

- **بيئة المختبر فقط**: الخادم الضعيف ضعيف عمداً
- **الاستخدام الإنتاجي**: لا تستخدم أبداً أسرار ضعيفة أو `alg: none` في الإنتاج
- **HTTPS مطلوب**: استخدم HTTPS في الإنتاج لحماية الرموز في العبور
- **إدارة الأسرار**: قم بتدوير الأسرار بانتظام في الإنتاج
- **تخزين الرموز**: فضل ملفات تعريف الارتباط HttpOnly على localStorage لرموز التحديث

## 📚 أهداف التعلم

بعد إكمال هذا المختبر، يجب أن تفهم:

1. **أفضل ممارسات أمان JWT**
   - توليد وإدارة الأسرار القوية
   - التحقق الصحيح من المطالبات (iss, aud, alg)
   - إدارة عمر الرمز

2. **ثغرات JWT الشائعة**
   - هجمات خلط الخوارزميات
   - استغلال الأسرار الضعيفة
   - هجمات سرقة وإعادة تشغيل الرموز

3. **استراتيجيات رمز التحديث**
   - دوران الرمز للأمان
   - تتبع الرمز على الخادم
   - حماية ملفات تعريف الارتباط HttpOnly

## 🎯 نتائج الاختبارات

### ✅ نتائج الهجمات

**الخادم الضعيف (المنفذ 1234):**
- هجوم خوارزمية None: نجح (200 OK)
- هجوم السر الضعيف: نجح (200 OK)

**الخادم الآمن (المنفذ 1235):**
- هجوم خوارزمية None: محجوب (401 Unauthorized)
- هجوم السر الضعيف: محجوب (401 Unauthorized)

### 🔒 الميزات الأمنية المطبقة

1. ✅ تكوين البيئة مع ملف .env
2. ✅ إزالة الأسرار الضعيفة المبرمجة
3. ✅ فرض مطالبات الرمز (iss, aud) والتحقق
4. ✅ تنفيذ استراتيجية رمز التحديث مع الدوران
5. ✅ الحفاظ على الواجهة الأمامية الموجودة مع تغييرات طفيفة
6. ✅ عرض الهجمات على الخادم الضعيف
7. ✅ إظهار فشل الهجمات على الخادم المحمي
8. ✅ توثيق تحليل حركة المرور مع Wireshark

---

**⚠️ إخلاء المسؤولية**: هذا المختبر للأغراض التعليمية فقط. الخادم الضعيف يحتوي على كود ضعيف عمداً ولا يجب استخدامه أبداً في بيئات الإنتاج.

## 🚀 كيفية الاستخدام

1. **تشغيل الخوادم:**
   ```bash
   npm run start-vuln    # المنفذ 1234 (ضعيف)
   npm run start-secure  # المنفذ 1235 (آمن)
   ```

2. **اختبار الهجمات:**
   ```bash
   node attack-demos.js  # توليد رموز الهجوم
   node security-demo.js # عرض الملخص الكامل
   ```

3. **الوصول للتطبيق:**
   - الضعيف: http://localhost:1234
   - الآمن: http://localhost:1235

الخادم الآمن يحجب بنجاح جميع الهجمات المعروضة مع الحفاظ على وظيفة المصادقة الصحيحة.